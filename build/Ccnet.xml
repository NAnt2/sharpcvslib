<project name="Ccnet" default="Build">
    <property name="frameworks" value="net-1.1 mono-1.0"/>
    <target name="Build">
        <foreach item="String" in="${frameworks}" property="framework" delim=" ">
            <nant buildfile="SharpCvsLib.build" target="clean dist" verbose="true" inheritall="false">
                <properties>
                    <property name="nant.settings.currentframework" value="${framework}" readonly="true" />
                </properties>
            </nant>
        </foreach>
        
        <if test="${property::exists('dir.ccnet.log')}">
            <call target="CreateBuildText"/>
            <call target="Package"/>

            <!--  
                You will need to download junction (for symlinks) here: 
                http://www.sysinternals.com/ntw2k/source/misc.shtml#junction 
            -->
            <exec program="junction.exe">
                <arg value="-d"/>
                <arg value="${dir.ccnet.log}/latest"/>
            </exec>
            <exec program="junction.exe">
                <arg value="${dir.ccnet.log}/latest"/>
                <arg value="${dir.ccnet.log}/${label-to-apply}"/>
            </exec>
        </if>    
    </target> 
    
    <target name="Package">
        <mkdir dir="${ccnet.log.dir}/${label-to-apply}"/>
        <zip zipfile="${ccnet.log.dir}/${label-to-apply}/${assembly.version}-src.zip">
            <fileset basedir="${dir.dist}/src">
                <include name="**" />
                <exclude name=".externalToolBuilders/**"/>
            </fileset>
            <fileset basedir="${dir.dist}/bin" prefix="bin">
                <include name="bin/**"/>
            </fileset>
        </zip>
        <zip zipfile="${ccnet.log.dir}/${label-to-apply}/${assembly.version}-bin.zip">
            <fileset basedir="${dir.dist}/bin">
                <include name="**" />
            </fileset>
        </zip>
    </target>
    
    <target name="CreateBuildText">
            <sysinfo/>            
            <echo file="${dir.ccnet.log}/${label-to-apply}/build.txt">
Sporadicism Build Server (http://www.build.sporadicism.com)
-----------------------------------------------------------

Computer:   ${sys.env.COMPUTERNAME}
Date:       ${datetime::now()}
Label:      ${label-to-apply}
Frameworks: ${frameworks}
OS:         ${environment::get-operating-system()}
            
            </echo>
    </target>
</project>